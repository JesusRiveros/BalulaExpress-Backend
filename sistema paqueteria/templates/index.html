<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>BALULA ENVIOS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #d1e0ff; }
        .logo { max-height: 100px; margin-bottom: 20px; }
        #map { height: 300px; width: 100%; border-radius: 10px; margin-top: 20px; }
        .card-section {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .box-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-between; 
        }
        .box-card {
            flex: 1 1 calc(25% - 10px);
            border: 2px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            min-width: 180px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }
        .box-card:hover, .box-card.selected {
            border-color: #28a745;
            background-color: #e9fbe8;
        }
        .box-card input {
            display: none;
        }
        .box-image {
            width: 80px;
            margin-bottom: 10px;
        }
        .valid-input {
            border-color: #28a745 !important;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        .valid-feedback-icon {
            position: absolute;
            right: 15px;
            top: 38px;
            color: #28a745;
            font-size: 1.2rem;
        }
        .position-relative {
            position: relative;
        }
        .check-icon-box {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #28a745;
            font-size: 1.2rem;
            display: none;
        }
        .box-card.selected .check-icon-box {
            display: inline;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="text-center mb-4">
        <img src="{{ url_for('static', filename='Balula logo.png') }}" class="logo" alt="Logo de la Empresa">
        <h1 class="mb-4">Calcula tu envío</h1>
    </div>

     
    {% include 'partials/stepper.html' %}

    <form action="/calculate" method="post" class="card-section" id="shipping-form">

        <div class="mb-3 position-relative">
            <label for="origin" class="form-label">Dirección de origen</label>
            <input type="text" class="form-control" id="origin" name="origin" placeholder="Ej. CDMX, México" required>
            <i class="fas fa-check-circle valid-feedback-icon d-none" id="icon-origin"></i>
        </div>

        <div class="mb-3 position-relative">
            <label for="autocomplete" class="form-label">Dirección de destino</label>
            <input type="text" class="form-control" id="autocomplete" name="destination" placeholder="Escribe una dirección" required>
            <i class="fas fa-check-circle valid-feedback-icon d-none" id="icon-autocomplete"></i>
        </div>

        <!-- Hidden inputs para guardar latitud y longitud -->
        <input type="hidden" id="lat_origin" name="lat_origin">
        <input type="hidden" id="lon_origin" name="lon_origin">
        <input type="hidden" id="lat" name="lat">
        <input type="hidden" id="lon" name="lon">

        <!-- Agrego este hidden para eco_packaging -->
        <input type="hidden" name="eco_packaging" value="standard">

        <div id="map"></div>

        <div class="mb-3 mt-4 position-relative">
            <label for="email" class="form-label">Correo electrónico del destinatario</label>
            <input type="email" class="form-control" id="email" name="email" placeholder="ejemplo@correo.com" required>
            <i class="fas fa-check-circle valid-feedback-icon d-none" id="icon-email"></i>
        </div>

        <div class="row">
            <div class="mb-3 col-md-3 position-relative">
                <label for="weight" class="form-label">Peso (kg)</label>
                <input type="number" step="0.01" class="form-control" id="weight" name="weight" required>
                <i class="fas fa-check-circle valid-feedback-icon d-none" id="icon-weight"></i>
            </div>
            <div class="mb-3 col-md-3 position-relative">
                <label for="length" class="form-label">Largo (cm)</label>
                <input type="number" step="0.01" class="form-control" id="length" name="length" required>
                <i class="fas fa-check-circle valid-feedback-icon d-none" id="icon-length"></i>
            </div>
            <div class="mb-3 col-md-3 position-relative">
                <label for="width" class="form-label">Ancho (cm)</label>
                <input type="number" step="0.01" class="form-control" id="width" name="width" required>
                <i class="fas fa-check-circle valid-feedback-icon d-none" id="icon-width"></i>
            </div>
            <div class="mb-3 col-md-3 position-relative">
                <label for="height" class="form-label">Alto (cm)</label>
                <input type="number" step="0.01" class="form-control" id="height" name="height" required>
                <i class="fas fa-check-circle valid-feedback-icon d-none" id="icon-height"></i>
            </div>
        </div>  

        <p><strong>Caja recomendada:</strong> <span id="box-suggestion">—</span></p>

        <div class="mb-3">
            <label class="form-label">Selecciona el tipo de caja:</label>
            <div class="box-grid" id="box-options"></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Tipo de entrega:</label><br>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="tipo_entrega" id="recolector" value="recolector" required>
                <label class="form-check-label" for="recolector"><i class="fas fa-truck me-1"></i> Recolector a domicilio</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="tipo_entrega" id="centro_autorizado" value="centro_autorizado">
                <label class="form-check-label" for="centro_autorizado"><i class="fas fa-building me-1"></i> Centro autorizado</label>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Tipo de envío</label><br>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="shipping_type" id="fast" value="fast" required>
                <label class="form-check-label" for="fast"><i class="fas fa-rocket me-1"></i> Rápido (1-2 días)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="shipping_type" id="eco" value="eco" required>
                <label class="form-check-label" for="eco"><i class="fas fa-turtle me-1"></i> Ecológico (3-5 días)</label>
            </div>
        </div>

        <div id="carbon-section" style="display:none;" class="mb-3">
            <p><i class="fas fa-globe-americas me-2"></i> Este envío emite aproximadamente <strong>2.1kg de CO₂</strong>.</p>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="yes" id="compensate" name="compensate">
                <label class="form-check-label" for="compensate">
                    Deseo compensar con $5 MXN para reforestar <i class="fas fa-seedling ms-1"></i>
                </label>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-primary">Calcular</button>
        </div>
    </form>
</div>

<script>
    let originLocation = null;
    let destinationLocation = null;

    function initAutocomplete() {
        const inputOrigen = document.getElementById("origin");
        const inputDestino = document.getElementById("autocomplete");

        const autocompleteOrigen = new google.maps.places.Autocomplete(inputOrigen, {
            types: ["geocode"],
            fields: ["geometry"]
        });

        const autocompleteDestino = new google.maps.places.Autocomplete(inputDestino, {
            types: ["geocode"],
            fields: ["geometry"]
        });

        autocompleteOrigen.addListener("place_changed", () => {
            const place = autocompleteOrigen.getPlace();
            if (!place.geometry || !place.geometry.location) return;
            originLocation = place.geometry.location;
            document.getElementById("lat_origin").value = originLocation.lat();
            document.getElementById("lon_origin").value = originLocation.lng();
            updateMapWithBothLocations();
        });

        autocompleteDestino.addListener("place_changed", () => {
            const place = autocompleteDestino.getPlace();
            if (!place.geometry || !place.geometry.location) return;
            destinationLocation = place.geometry.location;
            document.getElementById("lat").value = destinationLocation.lat();
            document.getElementById("lon").value = destinationLocation.lng();
            updateMapWithBothLocations();
        });
    }

    function updateMapWithBothLocations() {
        if (originLocation && destinationLocation) {
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 10,
                center: originLocation
            });

            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false
            });

            directionsService.route(
                {
                    origin: originLocation,
                    destination: destinationLocation,
                    travelMode: google.maps.TravelMode.DRIVING
                },
                (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);
                    } else {
                        alert("No se pudo calcular la ruta: " + status);
                    }
                }
            );

            document.getElementById("lat").value = destinationLocation.lat();
            document.getElementById("lon").value = destinationLocation.lng();
        }
    }

    // --- resto de tus funciones y lógica JS para cajas, validaciones, etc ---
    
    function suggestBoxes() {
        const l = parseFloat(document.getElementById('length').value);
        const w = parseFloat(document.getElementById('width').value);
        const h = parseFloat(document.getElementById('height').value);
        const weight = parseFloat(document.getElementById('weight').value);

        const container = document.getElementById('box-options');
        const suggestionSpan = document.getElementById('box-suggestion');
        container.innerHTML = '';
        suggestionSpan.textContent = '—';

        if (!isNaN(l) && !isNaN(w) && !isNaN(h) && !isNaN(weight)) {
            const vol = l * w * h;

            const boxes = [
                { id: 'small', name: 'Sobre A4', dims: '32x24x1 cm', cost: 5, maxVol: 768, maxWeight: 0.5, img: 'sobre.png' },
                { id: 'books', name: 'Uno o dos libros', dims: '23x14x4 cm', cost: 7, maxVol: 1288, maxWeight: 1.5, img: 'libros.png' },
                { id: 'shoes', name: 'Caja zapatos', dims: '35x20x15 cm', cost: 12, maxVol: 10500, maxWeight: 3, img: 'zapatos.png' },
                { id: 'move', name: 'Caja mudanza', dims: '75x35x35 cm', cost: 20, maxVol: 91875, maxWeight: 30, img: 'mudanza.png' }
            ];

            let recommendedBox = null;

            boxes.forEach(box => {
                if (vol <= box.maxVol && weight <= box.maxWeight) {
                    container.innerHTML += `
                        <label class="box-card" for="box_${box.id}">
                            <input type="radio" name="box_choice" id="box_${box.id}" value="${box.id}" required>
                            <div class="box-content">
                                <img src="/static/${box.img}" class="box-image" alt="${box.name}">
                                <strong>${box.name}</strong><br>
                                Medidas: ${box.dims}<br>
                                Costo adicional: $${box.cost}
                            </div>
                            <i class="fas fa-check-circle check-icon-box"></i>
                        </label>
                    `;

                    if (!recommendedBox) recommendedBox = box;
                }
            });

            if (recommendedBox) {
                suggestionSpan.textContent = recommendedBox.name;
            } else {
                suggestionSpan.textContent = 'No hay caja disponible para ese tamaño/peso.';
            }
        }
    }

    ['length', 'width', 'height', 'weight'].forEach(id => {
        document.getElementById(id).addEventListener('input', suggestBoxes);
    });

    document.querySelectorAll('input[name="shipping_type"]').forEach((el) => {
        el.addEventListener('change', function () {
            const section = document.getElementById('carbon-section');
            section.style.display = this.value === 'fast' ? 'block' : 'none';
        });
    });

    function showValid(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);

        if (input.value.trim() !== '') {
            input.classList.add('valid-input');
            icon.classList.remove('d-none');
        } else {
            input.classList.remove('valid-input');
            icon.classList.add('d-none');
        }
    }

    document.getElementById('email').addEventListener('input', function() {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (regex.test(this.value)) {
            showValid('email', 'icon-email');
        } else {
            document.getElementById('email').classList.remove('valid-input');
            document.getElementById('icon-email').classList.add('d-none');
        }
    });

    ['autocomplete', 'origin', 'weight', 'length', 'width', 'height'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => {
            showValid(id, `icon-${id}`);
        });
    });

    document.addEventListener('change', function(e) {
        if (e.target.name === 'box_choice') {
            document.querySelectorAll('.box-card').forEach(card => card.classList.remove('selected'));
            const label = e.target.closest('.box-card');
            if (label) label.classList.add('selected');
        }
    });
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAo9QR9HJwEH0zL-M9kdqFC1-TPULtzvWk&libraries=places&callback=initAutocomplete"
  async
  defer>
</script>
</body>
</html>
